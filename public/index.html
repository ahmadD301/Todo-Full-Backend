<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App | Node.JS Express.JS SQLite</title>
    
    <!-- CSS files - paths are correct -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="fanta.css" />
    
    <!-- Fixed Font Awesome without integrity issue -->
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
          crossorigin="anonymous" 
          referrerpolicy="no-referrer" />
</head>
<body>
    <section id="auth">
        <div>
            <h2 class="sign-up-text">Login</h2>
            <p>Create an account!</p>
        </div>

        <p id="error" style="display: none;"></p>
        <input id="emailInput" placeholder="Email" />
        <input id="passwordInput" placeholder="********" type="password" />
        <button id="authBtn" onclick="authenticate()">
            Submit
        </button>
        <hr />
        <div class="register-content">
            <p>Don't have an account?</p>
            <button onclick="toggleIsRegister()" id="registerBtn">Sign up</button>
        </div>
    </section>
    <header style="display: none;">
        <h1 class="text-gradient">You have 0 open tasks.</h1>
    </header>
    <nav style="display: none;" class="tab-container">
        <button onclick="changeTab('All')" class="tab-button selected-tab">
            <h4>All <span>(0)</span></h4>
        </button>
        <button onclick="changeTab('Open')" class="tab-button">
            <h4>Open <span>(0)</span></h4>
        </button>
        <button onclick="changeTab('Complete')" class="tab-button">
            <h4>Complete <span>(0)</span></h4>
        </button>
        <hr />
    </nav>
    <main style="display: none;"></main>
</body>
<script>
    let token = localStorage.getItem('token')
    let isLoading = false
    let isAuthenticating = false
    let isRegistration = false
    let selectedTab = 'All'
    let todos = []

    const apiBase = '/'

    // elements
    const nav = document.querySelector('nav')
    const header = document.querySelector('header')
    const main = document.querySelector('main')
    const navElements = document.querySelectorAll('.tab-button')
    const authContent = document.getElementById('auth')
    const textError = document.getElementById('error')
    const email = document.getElementById('emailInput')
    const password = document.getElementById('passwordInput')
    const registerBtn = document.getElementById('registerBtn')
    const authBtn = document.getElementById('authBtn')

    // PAGE RENDERING LOGIC
    async function showDashboard() {
        nav.style.display = 'block'
        header.style.display = 'flex'
        main.style.display = 'flex'
        authContent.style.display = 'none'
        await fetchTodos()
    }

    function updateHeaderText() {
        const openTasks = todos.filter(todo => !todo.completed).length
        const newString = openTasks === 1 ?
            `You have 1 open task.` :
            `You have ${openTasks} open tasks.`
        header.querySelector('h1').innerText = newString
    }

    function updateNavCount() {
        navElements.forEach(ele => {
            const btnText = ele.innerText.split(' ')[0]

            // filter todos in here
            const count = todos.filter(val => {
                if (btnText === 'All') {
                    return true
                }
                return btnText === 'Complete' ?
                    val.completed :
                    !val.completed
            }).length

            // target inside space and update value
            ele.querySelector('span').innerText = `(${count})`
        })
    }

    function changeTab(tab) {
        selectedTab = tab
        navElements.forEach(val => {
            if (val.innerText.includes(tab)) {
                val.classList.add('selected-tab')
            } else {
                val.classList.remove('selected-tab')
            }
        })
        renderTodos()
    }

    function renderTodos() {
        updateNavCount()
        updateHeaderText()

        let todoList = ``
        todos.filter(val => {
            return selectedTab === 'All' ? true : selectedTab === 'Complete' ? val.completed : !val.completed
        }).forEach((todo) => {
            const taskIndex = todo.id
            todoList += `
            <div class="card todo-item ${todo.completed ? 'completed' : ''}">
                <p>${todo.task}</p>
                <div class="todo-buttons">
                    <button onclick="updateTodo(${taskIndex})" ${todo.completed ? 'disabled' : ''}>
                        <h6>${todo.completed ? 'Completed' : 'Mark Done'}</h6>
                    </button>
                    <button onclick="deleteTodo(${taskIndex})">
                        <h6>Delete</h6>
                    </button>
                </div>
            </div>
            `
        })
        todoList += `
        <div class="input-container">
            <input id="todoInput" placeholder="Add task" />
            <button onclick="addTodo()">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
        `
        main.innerHTML = todoList
    }

    // AUTH LOGIC
    function toggleIsRegister() {
        isRegistration = !isRegistration
        registerBtn.innerText = isRegistration ? 'Sign in' : 'Sign up'
        document.querySelector('#auth > div h2').innerText = isRegistration ? 'Sign Up' : 'Login'
        document.querySelector('.register-content p').innerText = isRegistration ? 'Already have an account?' : 'Don\'t have an account?'
        document.querySelector('.register-content button').innerText = isRegistration ? 'Sign in' : 'Sign up'
        authBtn.innerText = isRegistration ? 'Sign Up' : 'Login'
    }

    async function authenticate() {
        const emailVal = email.value
        const passVal = password.value

        // Validation
        if (isLoading || isAuthenticating || !emailVal || !passVal || passVal.length < 6) {
            textError.innerText = 'Please fill all fields (password must be at least 6 characters)'
            textError.style.display = 'block'
            return
        }

        textError.style.display = 'none'
        isAuthenticating = true
        authBtn.innerText = isRegistration ? 'Signing Up...' : 'Logging In...'

        try {
            const endpoint = isRegistration ? 'auth/register' : 'auth/login'
            const response = await fetch(apiBase + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: emailVal, password: passVal })
            })

            const data = await response.json()
            
            if (!response.ok) {
                throw new Error(data.message || 'Authentication failed')
            }

            if (data.auth && data.token) {
                token = data.token
                localStorage.setItem('token', token)
                await showDashboard()
            } else {
                throw new Error(data.message || 'Authentication failed')
            }

        } catch (err) {
            console.error('Auth error:', err)
            textError.innerText = err.message
            textError.style.display = 'block'
        } finally {
            authBtn.innerText = 'Submit'
            isAuthenticating = false
        }
    }

    function logout() {
        localStorage.removeItem('token')
        token = null
        nav.style.display = 'none'
        header.style.display = 'none'
        main.style.display = 'none'
        authContent.style.display = 'block'
        
        // Clear form fields
        email.value = ''
        password.value = ''
        textError.style.display = 'none'
    }

    // CRUD LOGIC
    async function fetchTodos() {
        if (!token) {
            logout()
            return
        }

        isLoading = true
        try {
            const response = await fetch(apiBase + 'todos', {
                headers: { 
                    'Authorization': `Bearer ${token}`  // Fixed: Added Bearer prefix
                }
            })

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed')
                }
                throw new Error('Failed to fetch todos')
            }

            const todosData = await response.json()
            todos = todosData
            renderTodos()
        } catch (err) {
            console.error('Fetch todos error:', err)
            if (err.message.includes('Authentication')) {
                logout()
            }
        } finally {
            isLoading = false
        }
    }

    async function updateTodo(id) {
        try {
            const todo = todos.find(val => val.id === id)
            if (!todo) return

            const response = await fetch(apiBase + 'todos/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`  // Fixed: Added Bearer prefix
                },
                body: JSON.stringify({ completed: !todo.completed })
            })

            if (!response.ok) {
                throw new Error('Failed to update todo')
            }

            await fetchTodos()
        } catch (err) {
            console.error('Update todo error:', err)
            alert('Failed to update todo: ' + err.message)
        }
    }

    async function deleteTodo(id) {
        if (!confirm('Are you sure you want to delete this todo?')) return

        try {
            const response = await fetch(apiBase + 'todos/' + id, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`  // Fixed: Added Bearer prefix
                }
            })

            if (!response.ok) {
                throw new Error('Failed to delete todo')
            }

            await fetchTodos()
        } catch (err) {
            console.error('Delete todo error:', err)
            alert('Failed to delete todo: ' + err.message)
        }
    }

    async function addTodo() {
        const todoInput = document.getElementById('todoInput')
        const task = todoInput.value.trim()

        if (!task) {
            alert('Please enter a task')
            return
        }

        try {
            const response = await fetch(apiBase + 'todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`  // Fixed: Added Bearer prefix
                },
                body: JSON.stringify({ task })
            })

            if (!response.ok) {
                throw new Error('Failed to add todo')
            }

            todoInput.value = ''
            await fetchTodos()
        } catch (err) {
            console.error('Add todo error:', err)
            alert('Failed to add todo: ' + err.message)
        }
    }

    // Initialize app
    if (token) {
        // Validate token on page load
        async function initializeApp() {
            try {
                await fetchTodos()
                showDashboard()
            } catch (err) {
                console.error('Initialization error:', err)
                logout()
            }
        }
        initializeApp()
    }

    // Add logout button to header (optional)
    document.addEventListener('DOMContentLoaded', function() {
        // You can add a logout button to the header here if needed
        const header = document.querySelector('header')
        if (header) {
            header.innerHTML += '<button onclick="logout()" style="margin-left: auto; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Logout</button>'
        }
    })
</script>
</html>